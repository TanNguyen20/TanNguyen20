name: Auto Convert LaTeX
on:
  push:
    paths:
      - '**/*.tex'
      - '!**/warmup.tex'

permissions:
  contents: write

jobs:
  convert_latex:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Process LaTeX files
        env:
          API_URL: ${{ secrets.RENDER_API_URL }} 
        run: |
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"

          # Find all .tex files
          find . -name "*.tex" -not -path "./.*" | while read file; do
            echo "Found file: $file"
            
            base_path="${file%.*}"
            clean_name=$(basename "$base_path")
            
            # --- PDF CONVERSION ---
            echo "--> Converting to PDF..."
            curl --fail --retry 5 --retry-connrefused --max-time 300 \
              -X POST \
              -F "file=@$file" \
              "$API_URL/convert/pdf?output_filename=$clean_name" \
              --output "$base_path.pdf"

            # --- MARKDOWN CONVERSION ---
            # If the file is 'main.tex', save it as 'README.md'
            # Otherwise, save it with its original name.
            if [[ "$clean_name" == "main" ]]; then
                echo "--> Converting main.tex to README.md..."
                curl --fail --retry 3 \
                  -X POST \
                  -F "file=@$file" \
                  "$API_URL/convert/markdown?output_filename=README" \
                  --output "README.md"
            else
                echo "--> Converting $clean_name.tex to $clean_name.md..."
                curl --fail --retry 3 \
                  -X POST \
                  -F "file=@$file" \
                  "$API_URL/convert/markdown?output_filename=$clean_name" \
                  --output "$base_path.md"
            fi
          done

      - name: Commit and Push changes
        run: |
          if [[ -n $(git status -s) ]]; then
            git add .
            git commit -m "Auto-convert LaTeX to PDF/README [skip ci]"
            git push
            echo "Successfully pushed converted files."
          else
            echo "No changes to commit."
          fi
